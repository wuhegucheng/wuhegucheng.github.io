{
    "version": "https://jsonfeed.org/version/1",
    "title": "今天也请继续加油 • All posts by \"nfs\" tag",
    "description": "",
    "home_page_url": "http://wuhegucheng.github.io",
    "items": [
        {
            "id": "http://wuhegucheng.github.io/2023/04/01/linux/lnmp%E6%9E%B6%E6%9E%84/03.%20NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/01.%20NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/",
            "url": "http://wuhegucheng.github.io/2023/04/01/linux/lnmp%E6%9E%B6%E6%9E%84/03.%20NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/01.%20NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/",
            "title": "NFS共享存储",
            "date_published": "2023-04-01T08:46:15.000Z",
            "content_html": "<h1 id=\"nfs共享存储\"><a class=\"markdownIt-Anchor\" href=\"#nfs共享存储\">#</a> NFS 共享存储</h1>\n<h2 id=\"环境准备\"><a class=\"markdownIt-Anchor\" href=\"#环境准备\">#</a> 环境准备</h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">WanIP</th>\n<th style=\"text-align:center\">LanIP</th>\n<th style=\"text-align:center\">角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n<td style=\"text-align:center\">172.16.1.7</td>\n<td style=\"text-align:center\">网站服务（nfs 客户端）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">10.0.0.8</td>\n<td style=\"text-align:center\">172.16.1.8</td>\n<td style=\"text-align:center\">网站服务（nfs 客户端）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">nfs</td>\n<td style=\"text-align:center\">10.0.0.31</td>\n<td style=\"text-align:center\">172.16.1.31</td>\n<td style=\"text-align:center\">共享存储（nfs 服务端）</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"nfs概述\"><a class=\"markdownIt-Anchor\" href=\"#nfs概述\">#</a> NFS 概述</h2>\n<p><code>NFS（Network File System）</code> 通过网络来做文件存储</p>\n<p><code>NFS</code>  用于企业集群架构中 *,* 如果是大型网站 *,* 会用到更复杂的分布式文件系统 <code>FastDFS</code> , <code>glusterfs</code> , <code>HDFS</code></p>\n<blockquote>\n<p><strong>为什么使用共享存储？</strong></p>\n<ul>\n<li>\n<p>实现多台服务器之间数据共享</p>\n</li>\n<li>\n<p>实现多台服务器之间数据一致</p>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"nfs工作原理\"><a class=\"markdownIt-Anchor\" href=\"#nfs工作原理\">#</a> NFS 工作原理</h2>\n<p><img data-src=\"https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/image-20220518160108133.png\" alt=\"image-20220518160108133\"></p>\n<p>1. 用户进程访问 NFS 客户端，使用不同的函数对数据进行处理</p>\n<p>2.NFS 客户端通过 TCP/IP 的方式传递给 NFS 服务端</p>\n<p>3.NFS 服务端接收到请求后，会先调用 portmap 进程进行端口映射</p>\n<p>4.nfsd 进程用于判断 NFS 客户端是否拥有权限连接 NFS 服务端</p>\n<p>5.Rpc.mount 进程判断客户端是否有对应的权限进行验证</p>\n<p>6.idmap 进程实现用户映射和压缩</p>\n<p>7. 最后 NFS 服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件</p>\n<p><font color='red'><strong>注意: rpc 是一个远程过程调用，那么使用 nfs 必须有 rpc 服务</strong></font></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装apache、php</span></span><br><span class=\"line\">yum install -y httpd php</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#httpd站点目录</span></span><br><span class=\"line\">/var/www/html</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动服务</span></span><br><span class=\"line\">systemctl start httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改属主、属组</span></span><br><span class=\"line\"><span class=\"built_in\">chown</span> -R apache.apache /var/www/html/</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装部署nfs服务端\"><a class=\"markdownIt-Anchor\" href=\"#安装部署nfs服务端\">#</a> 安装部署 NFS 服务端</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#C5 C6安装nfs服务 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># yum install -y nfs rpcbind</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#C7安装nfs服务 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># yum install -y nfs-utils</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置NFS服务端 NFS配置文件的位置 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># ll /etc/exports </span></span><br><span class=\"line\">-rw-r--r--. 1 root root 0 Jun 7 2013 /etc/exports</span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># vim /etc/exports </span></span><br><span class=\"line\"><span class=\"comment\">#共享目录、允许访问NFS服务端的网段 (可读可写,同步,任何用户都映射成nfs的匿名用户) </span></span><br><span class=\"line\">/data 172.16.1.0/24(rw,<span class=\"built_in\">sync</span>,all_squash)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建共享目录 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># mkdir /data</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改共享目录的属主和属组为nfs的匿名用户 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># chown nfsnobody:nfsnobody /data</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动服务 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># systemctl start nfs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#加入开机自启 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># systemctl enable nfs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#检查进程 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># ps -ef|grep [n]fs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#检测配置文件是否生效 </span></span><br><span class=\"line\">[root@nfs ~]<span class=\"comment\"># cat /var/lib/nfs/etab</span></span><br><span class=\"line\">/data\t172.16.1.0/24(rw,<span class=\"built_in\">sync</span>,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,rw,secure,root_squash,all_squash)</span><br></pre></td></tr></table></figure>\n<h2 id=\"nfs配置详解\"><a class=\"markdownIt-Anchor\" href=\"#nfs配置详解\">#</a> NFS 配置详解</h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">nfs 共享参数</th>\n<th style=\"text-align:center\">参数作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">rw*</td>\n<td style=\"text-align:center\">客户端针对服务端的共享目录有可读，可写权限</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ro</td>\n<td style=\"text-align:center\">客户端针对服务端的共享目录只读权限</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">root_squash</td>\n<td style=\"text-align:center\">客户端必须是以 root 身份写入共享目录文件时，到服务端才能以 nfs 的系统用户写入（不常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">no_root_squash</td>\n<td style=\"text-align:center\">客户端以 root 身份连接服务端，也会以 nfs 服务器的 root 用户来操作共享目录（不常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">all_squash*</td>\n<td style=\"text-align:center\">无论 NFS 客户端用什么用户访问共享目录，到服务端都是 nfs 的系统用户权限（常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">no_all_squash</td>\n<td style=\"text-align:center\">无论 NFS 客户端使用什么账户访问，都不会变成 nfs 系统用户的身份（不常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sync*</td>\n<td style=\"text-align:center\">同时将数据写入到内存与硬盘中，保证不丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">async</td>\n<td style=\"text-align:center\">优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">anonuid*</td>\n<td style=\"text-align:center\">配置 all_squash 使用，指定 NFS 的用户 UID, 必须存在系统</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">anongid*</td>\n<td style=\"text-align:center\">配置 all_squash 使用，指定 NFS 的用户 UID, 必须存在系统</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"客户端操作\"><a class=\"markdownIt-Anchor\" href=\"#客户端操作\">#</a> 客户端操作</h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#1.安装nfs </span></span><br><span class=\"line\">[root@web01 ~]<span class=\"comment\"># yum install -y nfs-utils </span></span><br><span class=\"line\">[root@web02 ~]<span class=\"comment\"># yum install -y nfs-utils </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#2.查看哪些目录可以挂载 </span></span><br><span class=\"line\">[root@web01 ~]<span class=\"comment\"># showmount -e 172.16.1.31 </span></span><br><span class=\"line\">[root@web02 ~]<span class=\"comment\"># showmount -e 172.16.1.31 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#3.挂载共享目录 </span></span><br><span class=\"line\">[root@web01 ~]<span class=\"comment\"># mount -t nfs 172.16.1.31:/data /opt </span></span><br><span class=\"line\">[root@web02 ~]<span class=\"comment\"># mount -t nfs 172.16.1.31:/data /opt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看nfs配置文件是否生效</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> /var/lib/nfs/etab</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "NFS"
            ]
        }
    ]
}