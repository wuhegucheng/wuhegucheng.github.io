{
    "version": "https://jsonfeed.org/version/1",
    "title": "今天也请继续加油 • All posts by \"03.nfs共享存储\" category",
    "description": "",
    "home_page_url": "http://wuhegucheng.github.io",
    "items": [
        {
            "id": "http://wuhegucheng.github.io/2023/04/01/linux/lnmp%20build/03.NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/01.%20NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/",
            "url": "http://wuhegucheng.github.io/2023/04/01/linux/lnmp%20build/03.NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/01.%20NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8/",
            "title": "NFS共享存储",
            "date_published": "2023-04-01T08:46:15.000Z",
            "content_html": "<h1 id=\"nfs共享存储\"><a class=\"markdownIt-Anchor\" href=\"#nfs共享存储\">#</a> NFS 共享存储</h1>\n<h2 id=\"环境准备\"><a class=\"markdownIt-Anchor\" href=\"#环境准备\">#</a> 环境准备</h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">主机名</th>\n<th style=\"text-align:center\">WanIP</th>\n<th style=\"text-align:center\">LanIP</th>\n<th style=\"text-align:center\">角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">10.0.0.7</td>\n<td style=\"text-align:center\">172.16.1.7</td>\n<td style=\"text-align:center\">网站服务（nfs 客户端）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">10.0.0.8</td>\n<td style=\"text-align:center\">172.16.1.8</td>\n<td style=\"text-align:center\">网站服务（nfs 客户端）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">nfs</td>\n<td style=\"text-align:center\">10.0.0.31</td>\n<td style=\"text-align:center\">172.16.1.31</td>\n<td style=\"text-align:center\">共享存储（nfs 服务端）</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"nfs概述\"><a class=\"markdownIt-Anchor\" href=\"#nfs概述\">#</a> NFS 概述</h2>\n<p><code>NFS（Network File System）</code> 通过网络来做文件存储</p>\n<p><code>NFS</code>  用于企业集群架构中 *,* 如果是大型网站 *,* 会用到更复杂的分布式文件系统 <code>FastDFS</code> , <code>glusterfs</code> , <code>HDFS</code></p>\n<blockquote>\n<p><strong>为什么使用共享存储？</strong></p>\n<ul>\n<li>\n<p>实现多台服务器之间数据共享</p>\n</li>\n<li>\n<p>实现多台服务器之间数据一致</p>\n</li>\n</ul>\n</blockquote>\n<h2 id=\"nfs工作原理\"><a class=\"markdownIt-Anchor\" href=\"#nfs工作原理\">#</a> NFS 工作原理</h2>\n<p><img data-src=\"https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/image-20220518160108133.png\" alt=\"image-20220518160108133\"></p>\n<p>1. 用户进程访问 NFS 客户端，使用不同的函数对数据进行处理</p>\n<p>2.NFS 客户端通过 TCP/IP 的方式传递给 NFS 服务端</p>\n<p>3.NFS 服务端接收到请求后，会先调用 portmap 进程进行端口映射</p>\n<p>4.nfsd 进程用于判断 NFS 客户端是否拥有权限连接 NFS 服务端</p>\n<p>5.Rpc.mount 进程判断客户端是否有对应的权限进行验证</p>\n<p>6.idmap 进程实现用户映射和压缩</p>\n<p>7. 最后 NFS 服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件</p>\n<p><font color='red'><strong>注意: rpc 是一个远程过程调用，那么使用 nfs 必须有 rpc 服务</strong></font></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#安装 apache、php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> httpd php</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#httpd 站点目录</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/var/www/html</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#启动服务</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>systemctl start httpd</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#修改属主、属组</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> apache.apache /var/www/html/</pre></td></tr></table></figure><h2 id=\"安装部署nfs服务端\"><a class=\"markdownIt-Anchor\" href=\"#安装部署nfs服务端\">#</a> 安装部署 NFS 服务端</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#C5 C6 安装 nfs 服务 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y nfs rpcbind</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#C7 安装 nfs 服务 </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y nfs-utils</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#配置 NFS 服务端 NFS 配置文件的位置 </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /etc/exports </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-rw-r--r--. <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Jun <span class=\"token number\">7</span> <span class=\"token number\">2013</span> /etc/exports</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/exports </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#共享目录、允许访问 NFS 服务端的网段 (可读可写，同步，任何用户都映射成 nfs 的匿名用户) </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>/data <span class=\"token number\">172.16</span>.1.0/24<span class=\"token punctuation\">(</span>rw,sync,all_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#创建共享目录 </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#修改共享目录的属主和属组为 nfs 的匿名用户 </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown nfsnobody:nfsnobody /data</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#启动服务 </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nfs</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#加入开机自启 </span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable nfs</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#检查进程 </span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ps -ef|grep [n]fs</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#检测配置文件是否生效 </span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /var/lib/nfs/etab</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>/data\t<span class=\"token number\">172.16</span>.1.0/24<span class=\"token punctuation\">(</span>rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid<span class=\"token operator\">=</span><span class=\"token number\">65534</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">65534</span>,sec<span class=\"token operator\">=</span>sys,rw,secure,root_squash,all_squash<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"nfs配置详解\"><a class=\"markdownIt-Anchor\" href=\"#nfs配置详解\">#</a> NFS 配置详解</h2>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">nfs 共享参数</th>\n<th style=\"text-align:center\">参数作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">rw*</td>\n<td style=\"text-align:center\">客户端针对服务端的共享目录有可读，可写权限</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">ro</td>\n<td style=\"text-align:center\">客户端针对服务端的共享目录只读权限</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">root_squash</td>\n<td style=\"text-align:center\">客户端必须是以 root 身份写入共享目录文件时，到服务端才能以 nfs 的系统用户写入（不常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">no_root_squash</td>\n<td style=\"text-align:center\">客户端以 root 身份连接服务端，也会以 nfs 服务器的 root 用户来操作共享目录（不常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">all_squash*</td>\n<td style=\"text-align:center\">无论 NFS 客户端用什么用户访问共享目录，到服务端都是 nfs 的系统用户权限（常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">no_all_squash</td>\n<td style=\"text-align:center\">无论 NFS 客户端使用什么账户访问，都不会变成 nfs 系统用户的身份（不常用）</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">sync*</td>\n<td style=\"text-align:center\">同时将数据写入到内存与硬盘中，保证不丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">async</td>\n<td style=\"text-align:center\">优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">anonuid*</td>\n<td style=\"text-align:center\">配置 all_squash 使用，指定 NFS 的用户 UID, 必须存在系统</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">anongid*</td>\n<td style=\"text-align:center\">配置 all_squash 使用，指定 NFS 的用户 UID, 必须存在系统</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"客户端操作\"><a class=\"markdownIt-Anchor\" href=\"#客户端操作\">#</a> 客户端操作</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 安装 nfs </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y nfs-utils </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y nfs-utils </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2. 查看哪些目录可以挂载 </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># showmount -e 172.16.1.31 </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># showmount -e 172.16.1.31 </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#3. 挂载共享目录 </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 172.16.1.31:/data /opt </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 172.16.1.31:/data /opt</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#查看 nfs 配置文件是否生效</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">cat</span> /var/lib/nfs/etab</pre></td></tr></table></figure>",
            "tags": [
                "NFS"
            ]
        }
    ]
}